<!DOCTYPE html>
<html class="light" lang="ko">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
    <title>Tokyo Sakura Guide 2026</title>
    
    <!-- ğŸŒ¸ íŒŒë¹„ì½˜ ì„¤ì •: ë²šê½ƒ ì´ëª¨ì§€ -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸŒ¸</text></svg>">
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    
    <!-- ì•„ì´ì½˜ ê¹¨ì§ ë°©ì§€ë¥¼ ìœ„í•œ Material Symbols Outlined ê°•ì œ ë¡œë“œ -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL,GRAD,opsz@20..48,100..700,0..1,-50..200" rel="stylesheet" />
    
    <!-- Firebase SDK (ESM) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // í™˜ê²½ ë³€ìˆ˜ ê¸°ë°˜ ì„¤ì • (GitHub ë°°í¬ ì‹œ ë³´ì•ˆ ìœ ì§€)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'tokyo-sakura-2026';

        window.fb = { db, auth, appId, collection, addDoc, query, onSnapshot, serverTimestamp, signInAnonymously, signInWithCustomToken, onAuthStateChanged };
    </script>

    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#ea2a33",
                        "background-light": "#f8f6f6",
                        "background-dark": "#1a1111",
                        "sakura-pink": "#ffd1dc",
                        "sky-blue": "#e0f2fe",
                    },
                    fontFamily: {
                        "display": ["Plus Jakarta Sans", "Noto Sans JP", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "1rem", "lg": "2rem", "xl": "3rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        body { font-family: 'Plus Jakarta Sans', 'Noto Sans JP', sans-serif; -webkit-font-smoothing: antialiased; }
        .sakura-gradient { background: linear-gradient(180deg, #e0f2fe 0%, #ffffff 40%, #fff1f2 100%); background-attachment: fixed; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .transition-view { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* ì•„ì´ì½˜ í°íŠ¸ ê°•ì œ ì •ì˜ */
        .material-symbols-outlined {
            font-family: 'Material Symbols Outlined' !important;
            font-weight: normal; font-style: normal; font-size: 24px; line-height: 1;
            letter-spacing: normal; text-transform: none; display: inline-block;
            white-space: nowrap; word-wrap: normal; direction: ltr; -webkit-font-smoothing: antialiased;
        }

        /* ë²šê½ƒ ë‚™í™” ì• ë‹ˆë©”ì´ì…˜ */
        .petal { position: absolute; background-color: #ffdae9; border-radius: 150% 0 150% 0; opacity: 0.7; pointer-events: none; z-index: 1; animation: fall linear infinite; }
        @keyframes fall {
            0% { transform: translate(0, -10px) rotate(0deg); opacity: 0; }
            100% { transform: translate(100px, 100vh) rotate(360deg); opacity: 0; }
        }

        .itinerary-step::before { content: ''; position: absolute; left: 7px; top: 24px; bottom: -8px; width: 2px; background: #ea2a3320; }
        .itinerary-step:last-child::before { display: none; }
        
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* AI Loading ì• ë‹ˆë©”ì´ì…˜ */
        .ai-loading-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: .5; transform: scale(1.05); } }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-[#181111] dark:text-white transition-colors duration-300 antialiased overflow-x-hidden">
    
    <div id="petalContainer" class="fixed inset-0 pointer-events-none overflow-hidden z-0"></div>

    <div id="app" class="relative mx-auto flex h-auto min-h-screen w-full max-w-[480px] flex-col overflow-x-hidden shadow-2xl bg-white dark:bg-background-dark/30 backdrop-blur-[2px] sakura-gradient">
        
        <!-- View: Home -->
        <div id="homeView" class="transition-view flex flex-col w-full relative z-10">
            <div class="h-12 w-full"></div>
            
            <div class="px-6 flex justify-between items-center">
                <div class="flex items-center gap-2 text-left">
                    <span class="material-symbols-outlined text-primary text-2xl font-bold font-display">location_city</span>
                    <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest font-display">Tokyo 2026</span>
                </div>
                <button id="langBtnHome" class="px-4 py-2 rounded-full bg-white/80 dark:bg-black/40 backdrop-blur-md border border-white text-[10px] font-bold text-primary shadow-sm active:scale-95 transition-all">
                    JP / æ—¥æœ¬èª
                </button>
            </div>

            <!-- Hero Section -->
            <div class="relative h-[32vh] w-full flex flex-col items-center justify-center px-6 text-center">
                <div class="absolute top-5 opacity-5 pointer-events-none">
                    <span class="material-symbols-outlined text-[200px] text-primary font-bold">castle</span>
                </div>
                <div class="relative z-10 text-center">
                    <span id="labelSpringYear" class="inline-block px-4 py-1 rounded-full bg-white/40 dark:bg-black/20 backdrop-blur-sm text-[10px] font-black tracking-[0.2em] text-primary mb-4 uppercase border border-primary/10 font-display">Spring 2026 Edition</span>
                    <h1 id="homeHeroTitle" class="text-[#181111] dark:text-white tracking-tighter text-[38px] font-extrabold leading-[1.1]">ì˜¬ë´„ì—ëŠ” ê¼­ ê°€ì•¼ í•´</h1>
                    <div class="mt-3 flex items-center justify-center gap-3 text-center">
                        <span class="h-[1px] w-8 bg-primary/40"></span>
                        <h2 id="homeHeroSub" class="text-primary tracking-widest text-[22px] font-bold leading-tight">ë„ì¿„ ë²šê½ƒ ëª…ì†Œ</h2>
                        <span class="h-[1px] w-8 bg-primary/40"></span>
                    </div>
                </div>
            </div>

            <!-- Dynamic Bloom Forecast (2/9 ê¸°ì¤€ ë°˜ì˜) -->
            <div class="px-6 mb-4">
                <div class="bg-white/60 dark:bg-black/20 backdrop-blur-md rounded-2xl p-4 border border-white/40 flex items-center justify-between shadow-sm">
                    <div class="flex items-center gap-3 text-left font-display">
                        <div class="size-10 rounded-full bg-primary/10 flex items-center justify-center">
                            <span class="material-symbols-outlined text-primary text-xl font-display font-display font-display font-display font-display">insights</span>
                        </div>
                        <div>
                            <p id="labelForecastTitle" class="text-[10px] font-black text-gray-400 uppercase tracking-tighter font-display font-display">2026 Bloom Forecast</p>
                            <p id="labelForecastStatus" class="text-sm font-bold font-display font-display"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Icon Menu (4ëŒ€ ëª…ì†Œ ê³ ì •) -->
            <div class="px-6 py-4">
                <div class="grid grid-cols-4 gap-4 text-center">
                    <div class="flex flex-col items-center gap-2 cursor-pointer group" onclick="scrollToElement('locationListBest')">
                        <div class="flex size-14 items-center justify-center rounded-full bg-white/80 dark:bg-white/10 shadow-lg border border-sakura-pink/30 group-active:scale-90 transition-transform">
                            <span class="material-symbols-outlined text-primary text-2xl font-display font-display font-display font-display font-display font-display">waves</span>
                        </div>
                        <span class="text-[10px] font-extrabold text-gray-600 dark:text-gray-300 font-display">ë‚˜ì¹´ë©”êµ¬ë¡œ</span>
                    </div>
                    <div class="flex flex-col items-center gap-2 cursor-pointer group" onclick="scrollToElement('locationListBest')">
                        <div class="flex size-14 items-center justify-center rounded-full bg-white/80 dark:bg-white/10 shadow-lg border border-sakura-pink/30 group-active:scale-90 transition-transform font-display font-display font-display font-display font-display font-display">
                            <span class="material-symbols-outlined text-primary text-2xl font-display font-display">park</span>
                        </div>
                        <span class="text-[10px] font-extrabold text-gray-600 dark:text-gray-300 font-display">ìš°ì—ë…¸</span>
                    </div>
                    <div class="flex flex-col items-center gap-2 cursor-pointer group" onclick="scrollToElement('locationListBest')">
                        <div class="flex size-14 items-center justify-center rounded-full bg-white/80 dark:bg-white/10 shadow-lg border border-sakura-pink/30 group-active:scale-90 transition-transform font-display font-display font-display font-display font-display font-display font-display font-display">
                            <span class="material-symbols-outlined text-primary text-2xl font-display font-display">kayaking</span>
                        </div>
                        <span class="text-[10px] font-extrabold text-gray-600 dark:text-gray-300 font-display">í•œì¡°ëª¬</span>
                    </div>
                    <div class="flex flex-col items-center gap-2 cursor-pointer group" onclick="scrollToElement('locationListBest')">
                        <div class="flex size-14 items-center justify-center rounded-full bg-white/80 dark:bg-white/10 shadow-lg border border-sakura-pink/30 group-active:scale-90 transition-transform font-display font-display font-display font-display font-display font-display font-display font-display">
                            <span class="material-symbols-outlined text-primary text-2xl font-display font-display">nightlight</span>
                        </div>
                        <span class="text-[10px] font-extrabold text-gray-600 dark:text-gray-300 font-display">ë¡¯í°ê¸°</span>
                    </div>
                </div>
            </div>

            <!-- Best Spots Section (Fixed 4) -->
            <div class="px-6 py-6 pb-4 font-display font-display font-display font-display font-display">
                <h3 id="labelBestSpots" class="text-xl font-extrabold mb-6 font-display font-display font-display font-display font-display font-display">Best Spots</h3>
                <div id="locationListBest" class="flex flex-col gap-4 font-display font-display font-display font-display font-display font-display font-display font-display"></div>
            </div>

            <!-- More Spots Section (Explore More) -->
            <div class="px-6 py-6 pb-20">
                <div class="flex items-center gap-2 mb-6">
                    <span class="material-symbols-outlined text-primary text-xl font-bold font-display font-display font-display font-display font-display font-display font-display font-display font-display">new_releases</span>
                    <h3 id="labelMoreSpots" class="text-xl font-extrabold font-display font-display font-display font-display font-display font-display font-display font-display font-display font-display">Explore More</h3>
                </div>
                <div id="locationListMore" class="flex flex-col gap-4"></div>

                <!-- 1-Day Golden Course -->
                <div class="mt-16 mb-20 bg-white/60 dark:bg-white/5 backdrop-blur-md rounded-[2.5rem] p-8 border border-white shadow-xl font-display font-display font-display font-display font-display">
                    <div class="flex items-center justify-between mb-8 text-left font-display font-display font-display font-display font-display font-display font-display font-display font-display">
                        <div class="text-left font-display font-display font-display font-display font-display font-display font-display font-display font-display font-display font-display font-display">
                            <h3 id="labelCourseTitle" class="text-xl font-black tracking-tight font-display font-display font-display font-display font-display font-display font-display">ë„ì¿„ ë²šê½ƒ 1ì¼ í™©ê¸ˆ ë£¨íŠ¸</h3>
                            <p id="labelCourseSub" class="text-[10px] font-bold text-gray-400 uppercase mt-1 tracking-widest font-display font-display font-display font-display">Perfect Day Trip Itinerary</p>
                        </div>
                        <span class="material-symbols-outlined text-primary text-4xl font-bold font-display font-display font-display font-display font-display font-display font-display font-display font-display">auto_awesome</span>
                    </div>
                    <div id="homeCourseList" class="space-y-12 relative ml-4 text-left font-display font-display font-display font-display font-display font-display font-display font-display font-display font-display"></div>
                </div>
            </div>

            <div class="fixed bottom-8 left-1/2 -translate-x-1/2 w-[85%] max-w-[380px] z-40 text-center">
                <button class="w-full bg-primary text-white font-black py-4 rounded-full shadow-2xl shadow-primary/40 flex items-center justify-center gap-3 active:scale-95 transition-all border-t border-white/20 font-display font-display font-display font-display font-display">
                    <span class="material-symbols-outlined text-[20px] font-bold font-display font-display font-display font-display font-display">explore</span>
                    <span id="labelSpread">ê°€ì´ë“œë¶ í¼ì¹˜ê¸°</span>
                </button>
            </div>
        </div>

        <!-- View: Detail Overlay (ì˜¤ë¦¬ì§€ë„ ì‹œì•ˆ ìŠ¤íƒ€ì¼) -->
        <div id="detailView" class="transition-view fixed inset-0 z-50 translate-x-full bg-white dark:bg-background-dark overflow-y-auto hidden max-w-[480px] mx-auto shadow-2xl">
            <!-- Header -->
            <div class="sticky top-0 z-[60] flex items-center bg-white/90 dark:bg-background-dark/90 backdrop-blur-xl p-4 pb-2 justify-between border-b border-gray-50">
                <div onclick="closeDetail()" class="text-primary cursor-pointer p-2 active:scale-75 transition-transform"><span class="material-symbols-outlined text-[28px] font-black">arrow_back</span></div>
                <h2 id="detailHeaderTitle" class="text-[#181111] dark:text-white text-lg font-bold flex-1 text-center font-display">Location</h2>
                <div class="flex w-12 items-center justify-end"><button class="flex items-center justify-center rounded-full h-10 w-10 bg-primary/5 text-primary border border-primary/10 active:scale-90 transition-transform"><span class="material-symbols-outlined text-[20px] font-bold">share</span></button></div>
            </div>
            <div id="detailContent" class="pb-40"></div>
            <div class="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-[480px] bg-white/95 dark:bg-background-dark/95 backdrop-blur-xl border-t border-gray-100 p-5 pb-10 flex gap-3 z-[60] text-center font-display">
                <button class="flex-[1] h-14 rounded-full bg-primary/5 text-primary font-black text-sm border border-primary/10 active:scale-95 transition-all">Directions</button>
                <button id="addTripBtn" class="flex-[1.5] h-14 rounded-full bg-primary text-white font-black text-sm shadow-xl shadow-primary/30 active:scale-95 transition-all">
                    AI ì½”ìŠ¤ ìƒì„± âœ¨
                </button>
            </div>
        </div>

        <!-- Itinerary Modal -->
        <div id="itineraryModal" class="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-center justify-center p-6 hidden">
            <div class="bg-white dark:bg-background-dark w-full max-w-sm rounded-[2.5rem] overflow-hidden shadow-2xl flex flex-col max-h-[82vh]">
                <div class="p-8 pb-4">
                    <div class="flex justify-between items-start mb-6 text-left">
                        <div><h3 class="text-2xl font-black tracking-tight" id="modalCourseTitle">ë‚˜ë§Œì˜ 1ì¼ ì½”ìŠ¤</h3><p class="text-[10px] font-bold text-primary uppercase mt-1 tracking-widest font-display font-display font-display font-display font-display font-display">Tokyo Sakura Guide</p></div>
                        <button onclick="closeItinerary()" class="text-gray-300 hover:text-primary transition-colors"><span class="material-symbols-outlined font-bold">close</span></button>
                    </div>
                    <div id="itinerarySteps" class="space-y-4 overflow-y-auto hide-scrollbar max-h-[48vh] pr-2 text-left font-display"></div>
                </div>
                <div class="p-6 pt-0 mt-auto text-center"><button onclick="closeItinerary()" class="w-full bg-primary text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-all font-display font-display font-display font-display font-display">í™•ì¸</button></div>
            </div>
        </div>

        <!-- AI Loading Overlay -->
        <div id="aiLoading" class="fixed inset-0 z-[200] bg-white/90 dark:bg-background-dark/90 backdrop-blur-md flex flex-col items-center justify-center hidden">
            <div class="relative flex items-center justify-center mb-6 font-display font-display font-display font-display font-display font-display">
                <span class="material-symbols-outlined text-[80px] text-primary ai-loading-pulse font-display font-display font-display font-display font-display">auto_awesome</span>
                <div class="absolute inset-0 border-4 border-primary/20 rounded-full animate-ping font-display font-display font-display"></div>
            </div>
            <p class="text-xl font-black text-primary animate-pulse font-display">Geminiê°€ ì½”ìŠ¤ë¥¼ ì„¤ê³„ ì¤‘ì…ë‹ˆë‹¤... âœ¨</p>
        </div>
    </div>

    <script type="module">
        // --- Gemini API Logic ---
        const apiKey = ""; // Runtime-injected
        async function callGemini(prompt, systemInstruction) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] }
            };
            const fetchWithRetry = async (delay = 1000, retries = 5) => {
                try {
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error('API failed');
                    return await response.json();
                } catch (err) {
                    if (retries === 0) throw err;
                    await new Promise(r => setTimeout(r, delay));
                    return fetchWithRetry(delay * 2, retries - 1);
                }
            };
            const result = await fetchWithRetry();
            return result.candidates?.[0]?.content?.parts?.[0]?.text || "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        }

        const locations = [
            { id: 'nakameguro', isBest: true, icon: 'waves', img: 'https://images.unsplash.com/photo-1542931415-163ae57213ee?q=80&w=2070&auto=format&fit=crop', name: { kr: 'ë‚˜ì¹´ë©”êµ¬ë¡œ', jp: 'ä¸­ç›®é»’' }, sub: { kr: 'ë©”êµ¬ë¡œê°•ì˜ ë²šê½ƒ í„°ë„', jp: 'ç›®é»’å·ã®æ¡œã®ãƒˆãƒ³ãƒãƒ«' }, station: 'Nakameguro, Tokyo', stats: { crowd: { kr: 'ë§¤ìš° ë†’ìŒ', jp: 'éå¸¸ã«é«˜ã„' } }, history: { kr: '800ê·¸ë£¨ì˜ ë²šê½ƒì´ ë©”êµ¬ë¡œ ê°•ì„ ë”°ë¼ ë¶„í™ë¹› í„°ë„ì„ ë§Œë“­ë‹ˆë‹¤. ë°¤ì´ ë˜ë©´ ì¼œì§€ëŠ” í•‘í¬ìƒ‰ ì œë“±ì´ ë„ì¿„ ìµœê³ ì˜ ì•¼ê²½ì„ ì„ ì‚¬í•©ë‹ˆë‹¤.', jp: '800æœ¬ã®æ¡œãŒç›®é»’å·ã«æ²¿ã£ã¦ãƒ”ãƒ³ã‚¯ã®ãƒˆãƒ³ãƒãƒ«ã‚’ä½œã‚Šã¾ã™. æç¯ã®æ˜ã‹ã‚Šê°€ ë„ì¿„ì˜ ìƒì§•ì…ë‹ˆë‹¤.' }, tips: [ { kr: 'í•‘í¬ ìŠ¤íŒŒí´ë§ ì™€ì¸ì„ ë§ˆì‹œë©° ì‚°ì±…í•˜ì„¸ìš”.', jp: 'í•‘í¬ì˜ ìŠ¤íŒŒí´ë§ ì™€ì¸ë¥¼ ì¦ê²¨ë³´ì„¸ìš”.' }, { kr: 'ì˜¤í›„ 6ì‹œ ë¼ì´íŠ¸ì—…ì´ í•µì‹¬ì…ë‹ˆë‹¤.', jp: 'ë¼ì´íŠ¸ì—…ì„ ë†“ì¹˜ì§€ ë§ˆì„¸ìš”.' } ], attractions: [ { name: 'Starbucks Reserve', img: 'https://images.unsplash.com/photo-1509042239860-f550ce710b93?q=80&w=500&auto=format&fit=crop' }, { name: 'Onibus Coffee', img: 'https://images.unsplash.com/photo-1495474472287-4d71bcdd2085?q=80&w=500&auto=format&fit=crop' } ] },
            { id: 'ueno', isBest: true, icon: 'park', img: 'https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?q=80&w=2070&auto=format&fit=crop', name: { kr: 'ìš°ì—ë…¸ ê³µì›', jp: 'ä¸Šé‡æ©è³œå…¬åœ’' }, sub: { kr: 'ë„ì¿„ì—ì„œ ê°€ì¥ ì‚¬ë‘ë°›ëŠ” ê³µì›', jp: 'æ±äº¬ã§æœ€ã‚‚æ„›ã•ã‚Œã‚‹å…¬åœ’' }, station: 'Ueno, Taito, Tokyo', stats: { crowd: { kr: 'ë†’ìŒ', jp: 'é«˜ã„' } }, history: { kr: 'ìš°ì—ë…¸ ê³µì›ì€ 1,000ê·¸ë£¨ ì´ìƒì˜ ì‚¬ì¿ ë¼ ë‚˜ë¬´ê°€ ìˆëŠ” ë„ì¿„ì—ì„œ ê°€ì¥ ì—­ì‚¬ì ì¸ ëª…ì†Œì…ë‹ˆë‹¤. ì¼ë³¸ ìµœì´ˆì˜ ê³µì˜ ê³µì› ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤.', jp: 'ä¸Šé‡å…¬åœ’ã¯1,000æœ¬ä»¥ä¸Šã®æ¡œãŒã‚ã‚‹æ—¥æœ¬ã§æœ€ã‚‚æ­´å²çš„ãªå ´æ‰€ì…ë‹ˆë‹¤.' }, tips: [ { kr: 'ì˜¤ì „ ì¼ì° ë°©ë¬¸í•˜ì—¬ ëª…ë‹¹ì„ í™•ë³´í•˜ì„¸ìš”.', jp: 'ìë¦¬ í™•ë³´ë¥¼ ìœ„í•´ ì¼ì° ë°©ë¬¸í•©ì‹œë‹¤.' }, { kr: 'íŒŒë€ ë—ìë¦¬ì™€ ê²‰ì˜·ì„ ì±™ê¸°ì„¸ìš”.', jp: 'ë ˆì € ì‹œíŠ¸ì™€ ë°©í•œë³µì„ ìŠì§€ ë§ˆì„¸ìš”.' } ], attractions: [ { name: 'National Museum', img: 'https://images.unsplash.com/photo-1518998053574-53f0209f512d?q=80&w=500&auto=format&fit=crop' }, { name: 'Ueno Zoo', img: 'https://images.unsplash.com/photo-1534567153574-2b12153a87f0?q=80&w=500&auto=format&fit=crop' } ] },
            { id: 'chidori', isBest: true, icon: 'kayaking', img: 'https://images.unsplash.com/photo-1524413840807-0c3cb6fa8087?q=80&w=2070&auto=format&fit=crop', name: { kr: 'í•œì¡°ëª¬/ì¹˜ë„ë¦¬ê°€í›„ì¹˜', jp: 'åƒé³¥ãƒ¶æ·µ' }, sub: { kr: 'í•´ì ìœ„ë¡œ íë¥´ëŠ” ë²šê½ƒ', jp: 'ãŠå €ì— íë¥´ëŠ” æ¡œ' }, station: 'Kudanshita, Chiyoda, Tokyo', stats: { crowd: { kr: 'ë³´í†µ', jp: 'æ™®é€š' } }, history: { kr: 'í™©ê¶ í•´ìë¥¼ ë”°ë¼ ë³´íŠ¸ë¥¼ íƒ€ë©° ê°ìƒí•˜ëŠ” ë²šê½ƒì€ ë„ì¿„ì—ì„œ ê°€ì¥ ìš°ì•„í•œ í’ê²½ì…ë‹ˆë‹¤. ê³ ìš”í•˜ê³  í’ˆê²© ìˆëŠ” ë´„ì„ ë§Œë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', jp: 'çš‡å±…ã®ãŠå €ë¥¼ ë³´íŠ¸ë¡œ ë‚˜ì•„ê°€ë©° ê°ìƒí•˜ëŠ” ë²šê½ƒì…ë‹ˆë‹¤.' }, tips: [ { kr: 'ë³´íŠ¸ ëŒ€ê¸°ëŠ” ì˜¤í”ˆ ì „ë¶€í„° ì‹œì‘í•˜ì„¸ìš”.', jp: 'ë³´íŠ¸ëŠ” ì˜¤í”ˆ ì „ë¶€í„° ì¤„ ì„œëŠ” ê²ƒì„ ì¶”ì²œ.' } ], attractions: [ { name: 'Imperial Palace', img: 'https://images.unsplash.com/photo-1542352135-24e5b3b0dfb2?q=80&w=500&auto=format&fit=crop' } ] },
            { id: 'roppongi', isBest: true, icon: 'nightlight', img: 'https://images.unsplash.com/photo-1540959733332-eab4deabeeaf?q=80&w=2070&auto=format&fit=crop', name: { kr: 'ë¡¯í°ê¸° íì¦ˆ', jp: 'å…­æœ¬æœ¨ãƒ’ãƒ«ã‚º' }, sub: { kr: 'ë°¤ì˜ ì„¸ë ¨ëœ ë²šê½ƒ ì‚°ì±…', jp: 'éƒ½ä¼šì ì¸ å¤œæ¡œ' }, station: 'Roppongi Station, Tokyo', stats: { crowd: { kr: 'ë³´í†µ', jp: 'æ™®é€š' } }, history: { kr: 'ëª¨ë¦¬ ì •ì›ê³¼ ì‚¬ì¿ ë¼ìì¹´ë¥¼ ì‡ëŠ” ë¡¯í°ê¸°ì˜ ë²šê½ƒê¸¸ì€ í˜„ëŒ€ì ì¸ ë„ì‹œì˜ ë´„ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.', jp: 'æ¯›åˆ©åº­åœ’ê³¼ ã•ãã‚‰å‚ì„ ì‡ëŠ” ê³ ê¸‰ ëª…ì†Œì…ë‹ˆë‹¤.' }, tips: [ { kr: 'ì—°ëª»ì— ë¹„ì¹œ ë²šê½ƒì„ ë†“ì¹˜ì§€ ë§ˆì„¸ìš”.', jp: 'æ¯›åˆ©åº­åœ’ì˜ í’ê²½ì´ ì¼í’ˆì…ë‹ˆë‹¤.' } ], attractions: [ { name: 'Mori Art Museum', img: 'https://images.unsplash.com/photo-1518998053574-53f0209f512d?q=80&w=500&auto=format&fit=crop' } ] },
            { id: 'shinjuku', isBest: false, icon: 'park', img: 'https://images.unsplash.com/photo-1491884661903-66d4791c1214?q=80&w=2070&auto=format&fit=crop', name: { kr: 'ì‹ ì£¼ì¿  êµì—”', jp: 'æ–°å®¿å¾¡è‹‘' }, sub: { kr: 'ê±°ëŒ€í•œ ë„ì‹¬ íë§ ê°€ë“ ', jp: 'éƒ½ä¼šã®ã‚ªã‚¢ã‚·ã‚¹' }, station: 'Shinjuku-gyoemmae, Tokyo', stats: { crowd: { kr: 'ë³´í†µ', jp: 'æ™®é€š' } }, history: { kr: 'ë‹¤ì–‘í•œ ì¢…ì˜ ë²šê½ƒì´ ìˆì–´ ì˜¤ëœ ê¸°ê°„ ê½ƒêµ¬ê²½ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.', jp: 'å¤šæ§˜ãªæ¡œê°€ í•€ ë„ë‚´ ìµœëŒ€ ê·œëª¨ì˜ ì •ì›ì…ë‹ˆë‹¤.' }, tips: [ { kr: 'ì…ì¥ ì‹œ ì£¼ë¥˜ ë°˜ì…ì€ ê¸ˆì§€ì…ë‹ˆë‹¤.', jp: 'ìˆ  ë°˜ì…ì´ ê¸ˆì§€ë˜ì–´ ì¡°ìš©í•©ë‹ˆë‹¤.' } ], attractions: [ { name: 'NTT Docomo Tower', img: 'https://images.unsplash.com/photo-1503899036084-c55cdd92da26?q=80&w=500&auto=format&fit=crop' } ] },
            { id: 'sumida', isBest: false, icon: 'skis', img: 'https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?q=80&w=2070&auto=format&fit=crop', name: { kr: 'ìŠ¤ë¯¸ë‹¤ ê³µì›', jp: 'éš…ç”°å…¬åœ’' }, sub: { kr: 'ìŠ¤ì¹´ì´íŠ¸ë¦¬ ë²šê½ƒ ë·°', jp: 'ã‚¹ã‚«ì´íŠ¸ãƒªãƒ¼ã¨æ¡œ' }, station: 'Asakusa Station, Tokyo', stats: { crowd: { kr: 'ë†’ìŒ', jp: 'é«˜ã„' } }, history: { kr: 'ìŠ¤ë¯¸ë‹¤ ê°•ë³€ì„ ë”°ë¼ í¼ì³ì§„ ë²šê½ƒê¸¸ë¡œ, ë„ì¿„ ìŠ¤ì¹´ì´íŠ¸ë¦¬ë¥¼ ë°°ê²½ìœ¼ë¡œ ì‚¬ì§„ì„ ë‚¨ê¸°ê¸° ì¢‹ìŠµë‹ˆë‹¤.', jp: 'ìŠ¤ì¹´ì´íŠ¸ë¦¬ ë°°ê²½ì´ ì¼í’ˆì¸ ê°•ë³€ê¸¸ì…ë‹ˆë‹¤.' }, tips: [ { kr: 'ìˆ˜ìƒ ë²„ìŠ¤ ì²´í—˜ì„ ì¶”ì²œí•©ë‹ˆë‹¤.', jp: 'ìˆ˜ìƒ ë²„ìŠ¤ì—ì„œ ê°ìƒí•˜ì„¸ìš”.' } ], attractions: [ { name: 'Tokyo Skytree', img: 'https://images.unsplash.com/photo-1540959733332-eab4deabeeaf?q=80&w=500&auto=format&fit=crop' } ] },
            { id: 'kawazu', isBest: false, icon: 'event', img: 'https://images.unsplash.com/photo-1526368010889-da096d3277a1?q=80&w=2070&auto=format&fit=crop', name: { kr: 'ê°€ì™€ì¦ˆ (ê·¼êµ)', jp: 'æ²³æ´¥' }, sub: { kr: '2ì›”ì˜ ì¡°ê¸° ê°œí™” ë²šê½ƒ', jp: 'æ—©å’²ãã®æ²³æ´¥æ¡œ' }, station: 'Kawazu Station, Shizuoka', stats: { crowd: { kr: 'ë§¤ìš° ë†’ìŒ', jp: 'éå¸¸ã«é«˜ã„' } }, history: { kr: '2ì›” ì´ˆë¶€í„° í”¼ëŠ” ì§„í•œ ë¶„í™ìƒ‰ì˜ ê°€ì™€ì¦ˆìì¿ ë¼ ì¶•ì œë¡œ ìœ ëª…í•˜ë©° ë„ì¿„ì—ì„œ ê°€ì¥ ë¨¼ì € ë´„ì„ ë§Œë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', jp: '2æœˆåˆæ—¬ë¶€í„° ì¦ê¸°ëŠ” æ²³æ´¥æ¡œã¾ã¤ë¦¬ì…ë‹ˆë‹¤.' }, tips: [ { kr: '2ì›”ì¸ ì§€ê¸ˆì´ ë°©ë¬¸ ì ê¸°ì…ë‹ˆë‹¤!', jp: 'ä»Šê°€ æœ€é«˜ã®ã‚·ãƒ¼ã‚ºãƒ³ì…ë‹ˆë‹¤!' } ], attractions: [ { name: 'Kawazu Falls', img: 'https://images.unsplash.com/photo-1542483664-9f798835848c?q=80&w=500&auto=format&fit=crop' } ] }
        ];

        let currentLang = 'kr';
        let currentUser = null;
        let currentLocId = null;

        const uiStrings = {
            kr: { homeTitle: "ì˜¬ë´„ì—ëŠ” ê¼­ ê°€ì•¼ í•´", homeSub: "ë„ì¿„ ë²šê½ƒ ëª…ì†Œ", directions: "ê¸¸ ì°¾ê¸°", myTrip: "ë‚´ ì¼ì •ì— ì¶”ê°€", labelHistory: "History", labelTips: "Hanami Tips", labelAtt: "Nearby Attractions", labelLoc: "Location", labelCrowd: "Crowd Level", forecastTitle: "2026 ê°œí™” ì˜ˆì¸¡", step1: "ì¹˜ë„ë¦¬ê°€í›„ì¹˜ ë³´íŠ¸ ì‚°ì±…", step2: "ìš°ì—ë…¸ ê³µì› & ë°•ë¬¼ê´€", step3: "ë‚˜ì¹´ë©”êµ¬ë¡œ ì•¼ê°„ ë¼ì´íŠ¸ì—…", commentTitle: "í˜„ì¥ Talk", commentSubmit: "ë“±ë¡", commentPlaceholder: "í˜„ì¬ ë¶„ìœ„ê¸°ë¥¼ ê³µìœ í•˜ì„¸ìš”...", spread: "ê°€ì´ë“œë¶ í¼ì¹˜ê¸°", moreSpots: "Explore More" },
            jp: { homeTitle: "ä»Šå¹´çµ¶å¯¾è¡Œãã¹ã", homeSub: "æ±äº¬ã®æ¡œåæ‰€", directions: "ãƒ«ãƒ¼ãƒˆæ¡ˆå†…", myTrip: "ì¼ì •ì— ì¶”ê°€", labelHistory: "æ­´å²", labelTips: "ãŠèŠ±è¦‹ì˜ íŒ", labelAtt: "å‘¨è¾ºã®ã‚¹ãƒãƒƒãƒˆ", labelLoc: "ä½ç½®", labelCrowd: "æ··é›‘çŠ¶æ³", forecastTitle: "2026 é–‹èŠ±äºˆæƒ³", step1: "åƒé³¥ãƒ¶æ·µãƒœãƒ¼ãƒˆæ•£ç­–", step2: "ä¸Šé‡å…¬åœ’ ï¼† åšç‰©é¤¨", step3: "ä¸­ç›®é»’å¤œé–“ãƒ©ã‚¤ãƒˆã‚¢ãƒƒãƒ—", commentTitle: "ç¾ì§€ì˜ ëª©ì†Œë¦¬", commentSubmit: "é€ä¿¡", commentPlaceholder: "í˜„ì¬ì˜ ë¶„ìœ„ê¸°ë¥¼ ê³µìœ ...", spread: "ã‚¬ã‚¤ãƒ‰ë¶ ì—´ê¸°", moreSpots: "ã‚‚ã£ã¨è¦‹ã‚‹" }
        };

        // --- Core Logic ---
        function createPetals() {
            const container = document.getElementById('petalContainer');
            if (!container) return;
            container.innerHTML = '';
            for(let i=0; i<18; i++) {
                const petal = document.createElement('div');
                petal.className = 'petal';
                petal.style.left = Math.random() * 100 + 'vw';
                petal.style.width = Math.random() * 8 + 6 + 'px';
                petal.style.height = petal.style.width;
                petal.style.animationDuration = Math.random() * 4 + 6 + 's';
                petal.style.animationDelay = Math.random() * 5 + 's';
                container.appendChild(petal);
            }
        }

        function updateForecastByDate() {
            const today = new Date();
            const month = today.getMonth() + 1;
            const day = today.getDate();
            const forecastEl = document.getElementById('labelForecastStatus');
            let statusKR = (month < 2 || (month === 2 && day < 15)) ? "ì•„ì§ì€ ì¼ëŸ¬ìš”~ <span class='text-primary font-black'>ê²¨ìš¸ì </span> ìëŠ” ì¤‘ ğŸ’¤" : (month === 3 && day >= 15) ? "ê³§ <span class='text-primary font-black'>ê°œí™”</span>í•©ë‹ˆë‹¤! âœ¨" : "ë„ì¿„ëŠ” ì§€ê¸ˆ <span class='text-primary font-black'>ë§Œê°œ</span> ì§ì „! ğŸŒ¸";
            let statusJP = (month < 2 || (month === 2 && day < 15)) ? "ã¾ã æ—©ã„ã§ã™. <span class='text-primary font-black'>å†¬çœ </span> ä¸­ì…ë‹ˆë‹¤ ğŸ’¤" : "é–“ã‚‚ãªã <span class='text-primary font-black'>é–‹èŠ±</span> ã—ã¾ã™! âœ¨";
            if (forecastEl) forecastEl.innerHTML = currentLang === 'kr' ? statusKR : statusJP;
        }

        async function initAuth() {
            const { auth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } = window.fb;
            return new Promise((resolve) => {
                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    if (user) { currentUser = user; unsubscribe(); resolve(user); }
                    else { if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token); else await signInAnonymously(auth); }
                });
            });
        }

        function renderHomeList() {
            const listBest = document.getElementById('locationListBest');
            const listMore = document.getElementById('locationListMore');
            if (!listBest || !listMore) return;
            listBest.innerHTML = ''; listMore.innerHTML = '';
            locations.forEach(loc => {
                const card = document.createElement('div');
                card.className = "flex items-center justify-between p-5 bg-white/70 dark:bg-white/5 backdrop-blur-md border border-white/40 rounded-2xl shadow-sm active:scale-95 transition-all cursor-pointer text-left font-display";
                card.onclick = () => openDetail(loc.id);
                card.innerHTML = `<div class="flex items-center gap-4"><div class="size-11 rounded-full bg-primary/10 flex items-center justify-center shadow-sm"><span class="material-symbols-outlined text-primary text-xl font-bold font-display font-display font-display font-display font-display font-display font-display">${loc.icon}</span></div><div><p class="text-[14px] font-black text-[#181111] dark:text-white font-display font-display font-display font-display font-display">${loc.name[currentLang]}</p><p class="text-[10px] text-gray-500 font-bold mt-0.5 font-display font-display font-display">${loc.sub[currentLang]}</p></div></div><span class="material-symbols-outlined text-gray-300 font-display font-display font-display">chevron_right</span>`;
                if(loc.isBest) listBest.appendChild(card); else listMore.appendChild(card);
            });
        }

        function renderHomeCourse() {
            const list = document.getElementById('homeCourseList');
            if (!list) return;
            const lang = uiStrings[currentLang];
            list.innerHTML = `<div class="absolute left-[-21px] top-2 bottom-2 w-0.5 bg-gradient-to-b from-primary via-primary/40 to-primary/10 font-display"></div>
                <div class="relative text-left fade-in font-display"><div class="absolute -left-[32px] top-1 size-6 rounded-full bg-white border-4 border-primary z-10 flex items-center justify-center shadow-sm font-display font-display font-display font-display font-display"><span class="size-1.5 rounded-full bg-primary font-display font-display font-display font-display"></span></div><div><p class="text-[10px] font-black text-primary uppercase mb-1 font-display">09:00 AM</p><h4 class="text-base font-bold font-display">${lang.step1}</h4></div></div>
                <div class="relative text-left fade-in font-display font-display font-display font-display font-display font-display font-display font-display font-display font-display"><div class="absolute -left-[32px] top-1 size-6 rounded-full bg-white border-4 border-primary/40 z-10 flex items-center justify-center shadow-sm font-display font-display font-display font-display font-display font-display"><span class="size-1.5 rounded-full bg-primary/40 font-display"></span></div><div><p class="text-[10px] font-black text-primary uppercase mb-1 font-display">01:00 PM</p><h4 class="text-base font-bold font-display">${lang.step2}</h4></div></div>
                <div class="relative text-left fade-in font-display font-display font-display font-display font-display font-display font-display font-display font-display font-display font-display font-display"><div class="absolute -left-[32px] top-1 size-6 rounded-full bg-white border-4 border-primary/20 z-10 flex items-center justify-center shadow-sm font-display font-display"><span class="size-1.5 rounded-full bg-primary/20 font-display"></span></div><div><p class="text-[10px] font-black text-primary uppercase mb-1 font-display font-display font-display">06:30 PM</p><h4 class="text-base font-bold font-display font-display">${lang.step3}</h4></div></div>`;
        }

        async function openDetail(id) {
            currentLocId = id;
            const loc = locations.find(l => l.id === id);
            const view = document.getElementById('detailView');
            const lang = uiStrings[currentLang];
            document.getElementById('detailHeaderTitle').innerText = loc.name[currentLang];
            document.getElementById('detailContent').innerHTML = `
                <div class="px-4 py-2 text-center animate-fade-in"><div class="mx-auto w-full max-w-[440px] bg-center bg-cover flex flex-col justify-end overflow-hidden rounded-xl min-h-[280px] relative shadow-lg font-display" style="background-image: url('${loc.img}');"><div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent font-display font-display"></div><div class="relative p-6 text-left"><span class="bg-primary text-white text-[10px] font-bold uppercase tracking-widest px-3 py-1 rounded-full font-display font-display font-display">Recommended Spot</span></div></div></div>
                <div class="px-6 pt-6 pb-2 text-left animate-fade-in font-display"><h1 class="text-[#181111] dark:text-white tracking-tight text-[30px] font-extrabold font-display font-display font-display">${loc.name[currentLang]}</h1><div class="flex gap-3 mt-4 flex-wrap"><div class="flex h-9 items-center gap-x-2 rounded-full bg-primary/10 px-4 border border-primary/5 font-display font-display font-display font-display"><span class="material-symbols-outlined text-primary text-[18px] font-display font-display font-display">group</span><p class="text-primary text-xs font-semibold font-display font-display font-display font-display font-display font-display">${lang.labelCrowd}: ${loc.stats.crowd[currentLang]}</p></div><div class="flex h-9 items-center gap-x-2 rounded-full bg-green-100 dark:bg-green-900/30 px-4 font-display font-display font-display"><span class="material-symbols-outlined text-green-600 text-[18px] font-display">eco</span><p class="text-green-600 dark:text-green-400 text-xs font-semibold font-display font-display font-display">Bloom Season</p></div></div></div>
                
                <!-- AI Feature: Gemini Powered Hidden Gem âœ¨ -->
                <div class="px-6 py-4 font-display font-display font-display">
                    <button id="aiTipBtn" class="w-full bg-white border-2 border-primary/20 p-4 rounded-2xl flex items-center justify-between group active:scale-95 transition-all shadow-sm font-display font-display">
                        <div class="flex items-center gap-3">
                            <span class="material-symbols-outlined text-primary font-bold font-display font-display font-display font-display font-display">auto_awesome</span>
                            <p class="text-sm font-black text-primary font-display font-display">AI í˜„ì§€ì¸ ê¿€íŒ âœ¨</p>
                        </div>
                        <span class="material-symbols-outlined text-gray-300 group-hover:text-primary font-display font-display">expand_more</span>
                    </button>
                    <div id="aiTipContainer" class="mt-3 bg-primary/5 rounded-2xl p-5 hidden text-left text-sm font-bold text-gray-700 leading-relaxed border border-primary/10 animate-fade-in font-display font-display">
                        ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                    </div>
                </div>

                <div class="px-6 py-4 text-left animate-fade-in font-display font-display font-display"><h3 class="text-[#181111] dark:text-white text-xl font-bold mb-2 font-display font-display font-display font-display">${lang.labelHistory}</h3><p class="text-[#181111]/70 dark:text-white/70 text-base leading-relaxed font-display font-display font-display font-display font-display font-display">${loc.history[currentLang]}</p></div>
                <!-- Hanami Tips -->
                <div class="px-6 py-6 animate-fade-in text-center font-display font-display font-display font-display font-display font-display font-display"><div class="mx-auto bg-primary/5 dark:bg-primary/10 rounded-2xl p-6 border border-primary/20 max-w-[420px] shadow-sm font-display font-display font-display font-display"><div class="flex items-center justify-center gap-2 mb-4 font-display font-display font-display font-display font-display font-display font-display font-display font-display font-display font-display"><span class="material-symbols-outlined text-primary font-bold font-display font-display font-display">tips_and_updates</span><h3 class="text-primary text-lg font-extrabold uppercase font-display font-display font-display font-display font-display font-display">${lang.labelTips}</h3></div><ul class="space-y-4 text-left inline-block font-display font-display font-display font-display font-display font-display font-display">${loc.tips.map(tip => `<li class="flex gap-4 text-sm text-[#181114]/80 dark:text-white/80 font-bold leading-relaxed font-display font-display font-display font-display font-display"><span class="text-primary shrink-0 mt-0.5 font-display font-display font-display font-display font-display font-display font-display font-display">â€¢</span><span>${tip[currentLang]}</span></li>`).join('')}</ul></div></div>
                <!-- Attractions -->
                <div class="py-4 animate-fade-in font-display font-display font-display font-display font-display font-display font-display font-display font-display"><div class="px-6 flex justify-between items-center mb-4 font-display font-display font-display font-display font-display font-display font-display font-display"><h3 class="text-[#181111] dark:text-white text-xl font-bold font-display font-display font-display font-display font-display font-display font-display font-display">${lang.labelAtt}</h3><button class="text-primary text-sm font-extrabold font-display font-display font-display font-display">View All</button></div><div class="flex overflow-x-auto hide-scrollbar gap-4 px-6 pb-4 font-display font-display font-display font-display font-display">${loc.attractions.map(att => `<div class="min-w-[160px] w-[160px] flex flex-col gap-2 font-display font-display font-display font-display font-display font-display font-display font-display font-display font-display font-display font-display" style="background-image: url('${att.img}');"><div class="h-40 w-full rounded-xl bg-center bg-cover shadow-sm border border-black/5 font-display font-display font-display font-display font-display font-display font-display font-display font-display font-display font-display font-display font-display font-display font-display font-display font-display" style="background-image: url('${att.img}');"></div><p class="text-[#181111] dark:text-white text-[13px] font-bold leading-tight text-left font-display font-display font-display font-display font-display font-display font-display font-display font-display">${att.name}</p></div>`).join('')}</div></div>
                <!-- Talk Section -->
                <div class="px-6 py-10 mt-6 border-t border-gray-100 bg-gray-50/30 text-left animate-fade-in font-display font-display font-display font-display font-display font-display font-display font-display font-display"><h3 class="text-xl font-black mb-6 flex items-center gap-2 font-display font-display font-display font-display font-display font-display font-display font-display font-display font-display font-display font-display font-display"><span class="material-symbols-outlined text-primary font-display font-display font-display font-display font-display font-display font-display font-display font-display font-display font-display font-display">forum</span> ${lang.commentTitle}</h3><div id="commentList" class="space-y-4 mb-6 max-h-[300px] overflow-y-auto hide-scrollbar pr-2 font-display font-display font-display font-display font-display font-display font-display font-display font-display font-display"></div><div class="flex gap-2 p-2 bg-white rounded-2xl border border-gray-200 shadow-xl font-display font-display font-display font-display font-display font-display font-display font-display font-display font-display font-display font-display font-display font-display"><input type="text" id="commentInput" placeholder="${lang.commentPlaceholder}" class="flex-1 bg-transparent border-none focus:ring-0 text-sm px-3 font-medium font-display font-display font-display font-display font-display font-display font-display"><button id="sendBtn" class="bg-primary text-white text-xs font-bold px-5 py-2.5 rounded-xl font-display font-display font-display font-display font-display font-display font-display font-display font-display">ì „ì†¡</button></div></div>
            `;
            document.getElementById('sendBtn').onclick = () => window.submitComment();
            document.getElementById('aiTipBtn').onclick = () => getAiTip(loc);
            view.classList.remove('hidden'); setTimeout(() => view.classList.remove('translate-x-full'), 10);
            if (currentUser) await fetchComments(id); else { const user = await initAuth(); if (user) await fetchComments(id); }
        }

        async function getAiTip(loc) {
            const container = document.getElementById('aiTipContainer');
            container.classList.toggle('hidden');
            if (container.classList.contains('hidden')) return;
            const systemPrompt = `ë‹¹ì‹ ì€ ë„ì¿„ì˜ ì „ë¬¸ ì—¬í–‰ ê°€ì´ë“œì…ë‹ˆë‹¤. ì œê³µëœ ë²šê½ƒ ì¥ì†Œì— ëŒ€í•´ í˜„ì§€ì¸ë§Œ ì•„ëŠ” ë§¤ìš° êµ¬ì²´ì ì´ê³  ìœ ë‹ˆí¬í•œ ê¿€íŒ 1ê°€ì§€ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.`;
            const userPrompt = `${loc.name.kr} (${loc.sub.kr})ì— ëŒ€í•œ íŠ¹ë³„í•œ íŒì„ 100ì ì´ë‚´ë¡œ ì•Œë ¤ì¤˜.`;
            try { const response = await callGemini(userPrompt, systemPrompt); container.innerText = response; }
            catch (err) { container.innerText = "íŒì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."; }
        }

        window.handleAiItinerary = async () => {
            const loc = locations.find(l => l.id === currentLocId);
            if (!loc) return;
            document.getElementById('aiLoading').classList.remove('hidden');
            const systemPrompt = `ë‹¹ì‹ ì€ ë„ì¿„ ë²šê½ƒ ì—¬í–‰ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì‚¬ìš©ìê°€ ì„ íƒí•œ ì¥ì†Œë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì‹œê°„ëŒ€ë³„ ìµœì ì˜ 1ì¼ ì—¬í–‰ ì½”ìŠ¤ë¥¼ ë¦¬ìŠ¤íŠ¸ í˜•ì‹ìœ¼ë¡œ ìƒì„±í•˜ì„¸ìš”.`;
            const userPrompt = `${loc.name.kr}ì„(ë¥¼) í¬í•¨í•œ ì™„ë²½í•œ 1ì¼ ë²šê½ƒ ì—¬í–‰ ì¼ì •ì„ í•œêµ­ì–´ë¡œ ì‘ì„±í•´ì¤˜.`;
            try { const response = await callGemini(userPrompt, systemPrompt); displayAiItinerary(response); }
            catch (err) { alert("ì˜¤ë¥˜ ë°œìƒ"); }
            finally { document.getElementById('aiLoading').classList.add('hidden'); }
        };

        function displayAiItinerary(text) {
            const stepsEl = document.getElementById('itinerarySteps'); stepsEl.innerHTML = '';
            const div = document.createElement('div');
            div.className = "bg-primary/5 p-5 rounded-2xl border border-primary/10 font-bold text-sm leading-loose whitespace-pre-line";
            div.innerHTML = text; stepsEl.appendChild(div);
            document.getElementById('itineraryModal').classList.remove('hidden');
        }

        async function fetchComments(id) {
            const { db, appId, query, onSnapshot, collection } = window.fb;
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', `comments_${id}`));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('commentList'); if (!list) return; list.innerHTML = '';
                const sorted = snapshot.docs.map(d => d.data()).sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                if (sorted.length === 0) { list.innerHTML = `<p class="text-center text-xs text-gray-400 py-4 italic font-display">ì²« ì†Œì‹ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</p>`; return; }
                sorted.forEach(data => { const el = document.createElement('div'); el.className = "p-4 bg-white rounded-2xl shadow-sm border border-white animate-fade-in text-left font-display font-display"; el.innerHTML = `<p class="text-[10px] text-gray-400 font-bold mb-1 font-display font-display font-display font-display">User_${data.userId?.substring(0,4)} â€¢ ${data.createdAt ? new Date(data.createdAt.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'ë°©ê¸ˆ'}</p><p class="text-[13px] font-bold text-gray-700 font-display font-display font-display font-display font-display">${data.text}</p>`; list.appendChild(el); });
            });
        }

        window.submitComment = async () => {
            const input = document.getElementById('commentInput'); if(!input.value.trim()) return; if (!currentUser) await initAuth();
            const { db, appId, addDoc, collection, serverTimestamp } = window.fb;
            try { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', `comments_${currentLocId}`), { text: input.value, userId: currentUser.uid, createdAt: serverTimestamp() }); input.value = ''; } catch (err) { console.error(err); }
        };

        function toggleLanguage() {
            currentLang = currentLang === 'kr' ? 'jp' : 'kr';
            document.getElementById('langBtnHome').innerText = currentLang === 'kr' ? 'JP / æ—¥æœ¬èª' : 'KR / í•œêµ­ì–´';
            document.getElementById('homeHeroTitle').innerText = uiStrings[currentLang].homeTitle;
            document.getElementById('homeHeroSub').innerText = uiStrings[currentLang].homeSub;
            document.getElementById('labelSpread').innerText = uiStrings[currentLang].spread;
            document.getElementById('labelMoreSpots').innerText = uiStrings[currentLang].moreSpots;
            renderHomeList(); renderHomeCourse(); updateForecastByDate(); if(currentLocId) openDetail(currentLocId);
        }

        window.onload = async () => {
            createPetals(); renderHomeList(); renderHomeCourse(); updateForecastByDate(); await initAuth();
            document.getElementById('langBtnHome').onclick = toggleLanguage;
            window.closeDetail = () => { document.getElementById('detailView').classList.add('translate-x-full'); setTimeout(() => document.getElementById('detailView').classList.add('hidden'), 500); };
            window.closeItinerary = () => document.getElementById('itineraryModal').classList.add('hidden');
        };

        window.scrollToElement = (id) => { const el = document.getElementById(id); if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
    </script>
</body>
</html>